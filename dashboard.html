<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,sans-serif;
  background:#020617;
  color:#e5e7eb;
}
header{
  background:#0f172a;
  padding:15px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}
.container{padding:20px}
.date-box{text-align:center;margin-bottom:20px}
.date-box input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
  padding:8px 12px;
  border-radius:8px;
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}
.card{
  background:#0f172a;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
.departments{
  margin-top:30px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:15px;
}
.dept-card{
  background:#0f172a;
  padding:15px;
  border-radius:12px;
}
.dept-card h4{
  text-align:center;
  color:#c7d2fe;
}
.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.box{
  background:#020617;
  border-radius:8px;
  padding:10px;
  font-size:13px;
}
.box h5{
  margin:0 0 8px;
  color:#93c5fd;
}
.att-row{
  display:flex;
  gap:10px;
  padding:6px 0;
  border-bottom:1px dashed #1e293b;
  align-items:center;
  font-size:12.5px;
}
.att-name{flex:2}
.att-loc{flex:1;color:#93c5fd}
.att-time{flex:0;color:#c7d2fe}
canvas{margin-top:30px}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div class="container">

<div class="date-box">
  <input type="date" id="datePicker">
</div>

<div class="cards">
  <div class="card"><h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸáŸÜÿØÿ≥ŸäŸÜ</h3><p id="totalCount">0</p></div>
  <div class="card"><h3>ÿ≠ÿ∂ÿ±</h3><p id="inCount">0</p></div>
  <div class="card"><h3>ÿ∫ÿßÿ®</h3><p id="outCount">0</p></div>
</div>

<canvas id="deptChart" height="120"></canvas>

<div class="departments" id="departmentsBox"></div>

</div>

<script>
/* ================== CONFIG ================== */

const API_URL =
"https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";

/* Engineer ‚Üí Department (FIXED SOURCE OF TRUTH) */
const ENGINEER_DEPT = {
  "Mohamed Abdellatif Abdelhamid Aly":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Efat Youssef Assad Hanna":"ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß",
  "Waleed Mahmoud Ismaiel Abdelrahim":"ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß",
  "Ahmed Abdelnasser Mohamed Aly":"ÿ™Ÿàÿ±ŸäÿØÿßÿ™",
  "Amr Abdullah Abdrabbo Hlhil":"ÿ¢ŸÑŸâ",
  "Wael Ibrahim Eid Mohamed":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Aly Aboseif Abdelbadea Aly Abosaif":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Mahmoud Fathy Youssef Ismail":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Hussien Kamel Abdelkarem Abdelelamam":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Reda Mekhemar Abdelhamid Abdelhakim":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Mohamed Khaled Mohamed Khaled":"ÿ™Ÿàÿ±ŸäÿØÿßÿ™",
  "Alaaeldien Mohamed Soliman AbdelhAlym":"ÿ¢ŸÑŸâ",
  "Afraim Shawky Mikhail Habashy":"ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß",
  "Mohamed Hussien Mohamed Ahmed":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Ahmed Abdelfattah Aly Aly":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Mohamed Moustafa Abdelrahman Reyad":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Abdullah Shaaban Saad Mourad":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Elfarouk Mohamed Ahmed Mohamed":"ŸÖÿ™ÿßÿ®ÿπŸá",
  "Essam Sayed Mohamed Seddik":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Eltawab Mahmoud Aly Aboelhassan":"ÿ¢ŸÑŸâ",
  "Ibrahim Abdelnaser Abdelshafy Abdellatif":"ÿ¢ŸÑŸâ",
  "Mohamed Saeed Aboelhagag Hassan":"ÿ¢ŸÑŸâ",
  "Ahmed Mohamed Farouk Abdelrheam":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Ahmed Rabie Abdelrazik Hussien":"ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß",
  "Mohamed Atef Mahmoud Elgeneidy":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Ali Ahmed Hassan Hamed":"ÿ¢ŸÑŸâ",
  "Assem Hassan Abdelshafy Hassan":"ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "Omar Metwally Ahmed Mohamed Salem":"ÿ¢ŸÑŸâ",
  "Abdelmoneam Hassan Hafez Karrat":"ÿ¢ŸÑŸâ",
  "Mahmoud Ramadan Mahmoud Abdelaziz":"ÿ¢ŸÑŸâ",
  "Mahmoud Khaled":"ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "Mohamed Youssef":"ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß"
};

const DEPARTMENTS = [
  "ÿ®ŸÜŸâ ÿ≥ŸàŸäŸÅ",
  "ÿ¥ŸÖÿßŸÑ ÿßŸÑŸÖŸÜŸäÿß",
  "ÿ™Ÿàÿ±ŸäÿØÿßÿ™",
  "ÿ¢ŸÑŸâ",
  "ÿ¨ŸÜŸàÿ® ÿßŸÑŸÖŸÜŸäÿß",
  "ŸÖÿ™ÿßÿ®ÿπŸá"
];

const ENGINEERS = Object.keys(ENGINEER_DEPT);
const TOTAL = ENGINEERS.length;

document.getElementById("totalCount").textContent = TOTAL;

let chart;

/* ================== DATE ================== */
const dateInput = document.getElementById("datePicker");
dateInput.value = new Date().toLocaleDateString("en-CA");
dateInput.addEventListener("change", loadDashboard);

/* ================== MAIN ================== */
function loadDashboard(){
  const selectedDate = dateInput.value;

  fetch(`${API_URL}?action=attendance&date=${selectedDate}`)
    .then(r=>r.json())
    .then(rows=>{

      /* Filter ONLY selected date */
      rows = rows.filter(r => r.date === selectedDate);

      const presentSet = new Set();
      const deptPresent = {};
      DEPARTMENTS.forEach(d=>deptPresent[d]=[]);

      rows.forEach(r=>{
        if(r.status==="IN" && ENGINEER_DEPT[r.name]){
          presentSet.add(r.name);
          const dept = ENGINEER_DEPT[r.name];
          deptPresent[dept].push({
            name:r.name,
            location:r.location || "-",
            time:r.time || "-"
          });
        }
      });

      document.getElementById("inCount").textContent = presentSet.size;
      document.getElementById("outCount").textContent = TOTAL - presentSet.size;

      renderDepartments(deptPresent, presentSet);
    });
}

/* ================== UI ================== */
function renderDepartments(deptPresent, presentSet){
  const box = document.getElementById("departmentsBox");
  box.innerHTML="";

  const chartIn=[], chartOut=[];

  DEPARTMENTS.forEach(dept=>{
    const allDeptEngineers =
      ENGINEERS.filter(e=>ENGINEER_DEPT[e]===dept);

    const present = deptPresent[dept].map(x=>x.name);
    const absent =
      allDeptEngineers.filter(e=>!presentSet.has(e));

    chartIn.push(present.length);
    chartOut.push(absent.length);

    box.innerHTML += `
    <div class="dept-card">
      <h4>${dept}</h4>
      <div class="split">
        <div class="box">
          <h5>ÿ≠ÿ∂ÿ± (${present.length})</h5>
          ${
            deptPresent[dept].map(p=>`
              <div class="att-row">
                <span class="att-name">${p.name}</span>
                <span class="att-loc">üìç ${p.location}</span>
                <span class="att-time">‚è∞ ${p.time}</span>
              </div>
            `).join("") || "-"
          }
        </div>
        <div class="box">
          <h5>ÿ∫ÿßÿ® (${absent.length})</h5>
          ${absent.join("<br>") || "-"}
        </div>
      </div>
    </div>`;
  });

  drawChart(chartIn, chartOut);
}

/* ================== CHART ================== */
function drawChart(inData, outData){
  if(chart) chart.destroy();

  chart = new Chart(document.getElementById("deptChart"),{
    type:"bar",
    data:{
      labels:DEPARTMENTS,
      datasets:[
        {label:"ÿ≠ÿ∂ÿ±", data:inData, backgroundColor:"#60a5fa"},
        {label:"ÿ∫ÿßÿ®", data:outData, backgroundColor:"#a5b4fc"}
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{labels:{color:"#e5e7eb"}}
      },
      scales:{
        x:{ticks:{color:"#e5e7eb"}},
        y:{ticks:{color:"#e5e7eb"}}
      }
    }
  });
}

loadDashboard();
</script>

</body>
</html>
