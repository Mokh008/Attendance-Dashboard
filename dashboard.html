<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      background: #0f172a;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      padding: 20px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .card {
      background: #0f172a;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .card h3 {
      margin: 0;
      font-size: 14px;
      color: #94a3b8;
    }
    .card p {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      color: #6366f1;
    }

    /* Charts */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .chart-box {
      background: #0f172a;
      padding: 20px;
      border-radius: 12px;
    }
    .chart-box h3 {
      text-align: center;
      margin-bottom: 15px;
      color: #cbd5f5;
    }
  </style>
</head>

<body>

<header>
  Attendance Dashboard
</header>

<div class="container">

  <!-- ===== Cards ===== -->
  <div class="cards">
    <div class="card">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
      <p id="total">-</p>
    </div>
    <div class="card">
      <h3>Ø­Ø¶Ø±</h3>
      <p id="inCount">-</p>
    </div>
    <div class="card">
      <h3>ØºØ§Ø¨</h3>
      <p id="outCount">-</p>
    </div>
  </div>

  <!-- ===== Charts ===== -->
  <div class="charts">
    <div class="chart-box">
      <h3>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
      <canvas id="attendanceDoughnut"></canvas>
    </div>

    <div class="chart-box">
      <h3>Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <canvas id="attendanceBar"></canvas>
    </div>
  </div>

</div>

<script>
  // ğŸ”´ API URL
  const API_URL = "https://script.google.com/macros/s/AKfycbx0ukVKpFEP3CMUL_xKtomZzZbixcB4nOVGdZtcsqNmbo6IQwnQRnkbB4wE1QwPS8-mdA/exec";

  // ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
  const user = JSON.parse(sessionStorage.getItem("user"));
  if (!user) {
    window.location.href = "index.html";
  }

  let doughnutChart = null;
  let barChart = null;

  function loadDashboard() {
    // âœ… ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠ ØµØ­ÙŠØ­ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«)
    const today = new Date().toLocaleDateString("en-CA");

    fetch(`${API_URL}?action=attendanceSummary&role=${user.role}&region=${user.region}&date=${today}`)
      .then(res => res.json())
      .then(summary => {

        // ===== Cards =====
        let total = 0;
        let present = 0;
        let absent = 0;

        Object.values(summary.departments).forEach(d => {
          total += d.total;
          present += d.present;
          absent += d.absent;
        });

        document.getElementById("total").textContent = total;
        document.getElementById("inCount").textContent = present;
        document.getElementById("outCount").textContent = absent;

        // ===== Doughnut Chart =====
        if (doughnutChart) doughnutChart.destroy();
        doughnutChart = new Chart(
          document.getElementById("attendanceDoughnut"),
          {
            type: "doughnut",
            data: {
              labels: ["Ø­Ø¶Ø±", "ØºØ§Ø¨"],
              datasets: [{
                data: [present, absent],
                backgroundColor: ["#22c55e", "#ef4444"]
              }]
            }
          }
        );

        // ===== Bar Chart =====
        const labels = Object.keys(summary.departments);
        const presentData = labels.map(d => summary.departments[d].present);
        const absentData = labels.map(d => summary.departments[d].absent);

        if (barChart) barChart.destroy();
        barChart = new Chart(
          document.getElementById("attendanceBar"),
          {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Ø­Ø¶Ø±",
                  data: presentData,
                  backgroundColor: "#22c55e"
                },
                {
                  label: "ØºØ§Ø¨",
                  data: absentData,
                  backgroundColor: "#ef4444"
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
              }
            }
          }
        );

      })
      .catch(() => {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§");
      });
  }

  // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
  loadDashboard();

  // Live Update ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
  setInterval(loadDashboard, 10000);
</script>

</body>
</html>
