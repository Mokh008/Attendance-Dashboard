<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,sans-serif;
  background:#020617;
  color:#e5e7eb;
}
header{
  background:#0f172a;
  padding:15px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}
.container{padding:20px}
.date-box{text-align:center;margin-bottom:20px}
.date-box input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
  padding:8px 12px;
  border-radius:8px;
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}
.card{
  background:#0f172a;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
.departments{
  margin-top:30px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:15px;
}
.dept-card{
  background:#0f172a;
  padding:15px;
  border-radius:12px;
}
.dept-card h4{
  text-align:center;
  color:#c7d2fe;
}
.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.box{
  background:#020617;
  border-radius:8px;
  padding:10px;
  font-size:13px;
}
.att-row{
  display:flex;
  gap:8px;
  padding:6px 0;
  border-bottom:1px dashed #1e293b;
}
.att-name{flex:2}
.att-loc{flex:1;color:#93c5fd}
.att-time{color:#c7d2fe}

/* ===== Loader ===== */
#loader{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,.95);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  z-index:999;
}
.hidden{display:none}

canvas{margin-top:30px}
</style>
</head>

<body>

<div id="loader">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

<header>Attendance Dashboard</header>

<div class="container">

<div class="date-box">
  <input type="date" id="datePicker">
</div>

<div class="cards">
  <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3><p id="total">32</p></div>
  <div class="card"><h3>Ø­Ø¶Ø±</h3><p id="inCount">0</p></div>
  <div class="card"><h3>ØºØ§Ø¨</h3><p id="outCount">0</p></div>
</div>

<canvas id="deptChart" height="120"></canvas>
<canvas id="pieChart" height="120"></canvas>

<div class="departments" id="departmentsBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL="https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";

const ENGINEER_DEPT={/* Ù†ÙØ³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù„ÙŠ Ø§ØªÙÙ‚Ù†Ø§ Ø¹Ù„ÙŠÙ‡Ø§ */};
const DEPARTMENTS=["Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ","Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§","ØªÙˆØ±ÙŠØ¯Ø§Øª","Ø¢Ù„Ù‰","Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§","Ù…ØªØ§Ø¨Ø¹Ù‡"];
const ENGINEERS=Object.keys(ENGINEER_DEPT);
const TOTAL=ENGINEERS.length;

let barChart,pieChart;

/* ================= DATE ================= */
const dateInput=document.getElementById("datePicker");
const today=new Date().toLocaleDateString("en-CA");
dateInput.value=today;
dateInput.addEventListener("change",loadDashboard);

/* ================= MAIN ================= */
function showLoader(){document.getElementById("loader").classList.remove("hidden")}
function hideLoader(){document.getElementById("loader").classList.add("hidden")}

function loadDashboard(){
  showLoader();
  const selectedDate=dateInput.value;

  fetch(`${API_URL}?action=attendance&date=${selectedDate}`)
  .then(r=>r.json())
  .then(rows=>{
    rows=rows.filter(r=>r.date===selectedDate);

    const presentSet=new Set();
    const deptData={};
    DEPARTMENTS.forEach(d=>deptData[d]=[]);

    rows.forEach(r=>{
      if(r.status==="IN" && ENGINEER_DEPT[r.name]){
        presentSet.add(r.name);
        deptData[ENGINEER_DEPT[r.name]].push({
          name:r.name,
          location:r.location||"-",
          time:r.time||"-"
        });
      }
    });

    document.getElementById("inCount").textContent=presentSet.size;
    document.getElementById("outCount").textContent=TOTAL-presentSet.size;

    renderDepartments(deptData,presentSet);
    drawCharts(deptData,presentSet.size);

    hideLoader();
  });
}

/* ================= UI ================= */
function renderDepartments(deptData,presentSet){
  const box=document.getElementById("departmentsBox");
  box.innerHTML="";

  DEPARTMENTS.forEach(dept=>{
    const all=ENGINEERS.filter(e=>ENGINEER_DEPT[e]===dept);
    const present=deptData[dept].map(x=>x.name);
    const absent=all.filter(e=>!presentSet.has(e));

    box.innerHTML+=`
    <div class="dept-card">
      <h4>${dept}</h4>
      <div class="split">
        <div class="box">
          <b>Ø­Ø¶Ø± (${present.length})</b>
          ${deptData[dept].map(p=>`
            <div class="att-row">
              <span class="att-name">${p.name}</span>
              <span class="att-loc">ğŸ“ ${p.location}</span>
              <span class="att-time">â° ${p.time}</span>
            </div>`).join("")||"-"}
        </div>
        <div class="box">
          <b>ØºØ§Ø¨ (${absent.length})</b><br>
          ${absent.join("<br>")}
        </div>
      </div>
    </div>`;
  });
}

/* ================= Charts ================= */
function drawCharts(deptData,inCount){
  if(barChart) barChart.destroy();
  if(pieChart) pieChart.destroy();

  barChart=new Chart(deptChart,{
    type:"bar",
    data:{
      labels:DEPARTMENTS,
      datasets:[{
        label:"Ø­Ø¶Ø±",
        data:DEPARTMENTS.map(d=>deptData[d].length),
        backgroundColor:"#60a5fa"
      }]
    }
  });

  pieChart=new Chart(pieChart,{
    type:"pie",
    data:{
      labels:["Ø­Ø¶Ø±","ØºØ§Ø¨"],
      datasets:[{
        data:[inCount,TOTAL-inCount],
        backgroundColor:["#60a5fa","#a5b4fc"]
      }]
    }
  });
}

/* ================= AUTO REFRESH ================= */
setInterval(()=>{
  if(dateInput.value===today){
    loadDashboard();
  }
},30000);

loadDashboard();
</script>

</body>
</html>
