<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      background: #0f172a;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .container {
      padding: 20px;
    }

    /* ===== Summary Cards ===== */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .card {
      background: #0f172a;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .card h3 {
      margin: 0;
      font-size: 14px;
      color: #94a3b8;
    }
    .card p {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      color: #6366f1;
    }

    /* ===== Department Cards ===== */
    .departments {
      margin-top: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
    }

    .dept-card {
      background: #0f172a;
      padding: 15px;
      border-radius: 12px;
    }

    .dept-card h4 {
      margin: 0 0 10px;
      font-size: 15px;
      color: #c7d2fe;
      text-align: center;
    }

    .dept-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .present { color: #22c55e; }
    .absent { color: #ef4444; }

    .names {
      font-size: 12px;
      line-height: 1.6;
      max-height: 120px;
      overflow-y: auto;
      border-top: 1px solid #1e293b;
      padding-top: 8px;
    }

    /* ===== Charts ===== */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .chart-box {
      background: #0f172a;
      padding: 20px;
      border-radius: 12px;
    }
    .chart-box h3 {
      text-align: center;
      margin-bottom: 15px;
      color: #cbd5f5;
    }
  </style>
</head>

<body>

<header>
  Attendance Dashboard
</header>

<div class="container">

  <!-- ===== Summary Cards ===== -->
  <div class="cards">
    <div class="card">
      <h3>إجمالي الموظفين</h3>
      <p id="total">-</p>
    </div>
    <div class="card">
      <h3>حضر</h3>
      <p id="inCount">-</p>
    </div>
    <div class="card">
      <h3>غاب</h3>
      <p id="outCount">-</p>
    </div>
  </div>

  <!-- ===== Department Cards ===== -->
  <div class="departments" id="departmentsBox"></div>

  <!-- ===== Charts ===== -->
  <div class="charts">
    <div class="chart-box">
      <h3>الحضور اليوم</h3>
      <canvas id="attendanceDoughnut"></canvas>
    </div>

    <div class="chart-box">
      <h3>الحضور حسب الإدارة</h3>
      <canvas id="attendanceBar"></canvas>
    </div>
  </div>

</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";

  // حماية
  const user = JSON.parse(sessionStorage.getItem("user"));
  if (!user) location.href = "index.html";

  let doughnutChart = null;
  let barChart = null;

  function loadDashboard() {
    const today = new Date().toLocaleDateString("en-CA");

    fetch(`${API_URL}?action=attendanceSummary&role=${user.role}&region=${user.region}&date=${today}`)
      .then(res => res.json())
      .then(summary => {

        let total = 0, present = 0, absent = 0;
        const deptBox = document.getElementById("departmentsBox");
        deptBox.innerHTML = "";

        Object.entries(summary.departments).forEach(([dept, d]) => {
          total += d.total;
          present += d.present;
          absent += d.absent;

          deptBox.innerHTML += `
            <div class="dept-card">
              <h4>${dept}</h4>
              <div class="dept-stats">
                <span class="present">✔ حضر: ${d.present}</span>
                <span class="absent">✖ غاب: ${d.absent}</span>
              </div>
              <div class="names">
                <strong class="present">الحاضرين:</strong><br>
                ${(d.presentNames || []).join("، ") || "-"}
                <br><br>
                <strong class="absent">الغايبين:</strong><br>
                ${(d.absentNames || []).join("، ") || "-"}
              </div>
            </div>
          `;
        });

        document.getElementById("total").textContent = total;
        document.getElementById("inCount").textContent = present;
        document.getElementById("outCount").textContent = absent;

        // Doughnut
        if (doughnutChart) doughnutChart.destroy();
        doughnutChart = new Chart(attendanceDoughnut, {
          type: "doughnut",
          data: {
            labels: ["حضر", "غاب"],
            datasets: [{
              data: [present, absent],
              backgroundColor: ["#22c55e", "#ef4444"]
            }]
          }
        });

        // Bar
        const labels = Object.keys(summary.departments);
        if (barChart) barChart.destroy();
        barChart = new Chart(attendanceBar, {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "حضر", data: labels.map(l => summary.departments[l].present), backgroundColor: "#22c55e" },
              { label: "غاب", data: labels.map(l => summary.departments[l].absent), backgroundColor: "#ef4444" }
            ]
          },
          options: {
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      });
  }

  // تحميل أول مرة
  loadDashboard();

  // تحديث تلقائي كل 10 ثواني
  setInterval(loadDashboard, 10000);
</script>

</body>
</html>
