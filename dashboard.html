<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: #020617;
  color: #e5e7eb;
}

header {
  background: #0f172a;
  padding: 15px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

.container { padding: 20px; }

.date-box {
  text-align: center;
  margin-bottom: 20px;
}

.date-box input {
  background: #020617;
  color: #fff;
  border: 1px solid #334155;
  padding: 8px 12px;
  border-radius: 8px;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.card {
  background: #0f172a;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.card h3 { margin: 0; font-size: 14px; color: #94a3b8; }
.card p { margin-top: 10px; font-size: 26px; font-weight: bold; color: #6366f1; }

.departments {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 15px;
}

.dept-card {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
}

.dept-card h4 {
  text-align: center;
  color: #c7d2fe;
  margin-bottom: 10px;
}

.present { color: #22c55e; font-size: 13px; }

.names {
  font-size: 12px;
  margin-top: 8px;
  line-height: 1.6;
  border-top: 1px solid #1e293b;
  padding-top: 6px;
  max-height: 120px;
  overflow-y: auto;
}

.charts {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.chart-box {
  background: #0f172a;
  padding: 20px;
  border-radius: 12px;
}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div class="container">

  <!-- ðŸ“… Calendar -->
  <div class="date-box">
    <input type="date" id="datePicker">
  </div>

  <!-- Summary -->
  <div class="cards">
    <div class="card">
      <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
      <p id="total">-</p>
    </div>
    <div class="card">
      <h3>Ø­Ø¶Ø±</h3>
      <p id="inCount">-</p>
    </div>
    <div class="card">
      <h3>ØºØ§Ø¨</h3>
      <p id="outCount">-</p>
    </div>
  </div>

  <!-- Departments -->
  <div class="departments" id="departmentsBox"></div>

  <!-- Charts -->
  <div class="charts">
    <div class="chart-box">
      <canvas id="attendanceDoughnut"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="attendanceBar"></canvas>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";

const user = JSON.parse(sessionStorage.getItem("user"));
if (!user) location.href = "index.html";

const dateInput = document.getElementById("datePicker");
dateInput.value = new Date().toLocaleDateString("en-CA");

let doughnutChart = null;
let barChart = null;

dateInput.addEventListener("change", loadDashboard);

function loadDashboard() {
  const date = dateInput.value;

  Promise.all([
    fetch(`${API_URL}?action=dashboard&role=${user.role}&region=${user.region}&date=${date}`).then(r => r.json()),
    fetch(`${API_URL}?action=attendance&role=${user.role}&region=${user.region}&date=${date}`).then(r => r.json())
  ])
  .then(([summary, attendance]) => {

    document.getElementById("total").textContent   = summary.totalAttendance || 0;
    document.getElementById("inCount").textContent = summary.inCount || 0;
    document.getElementById("outCount").textContent= summary.outCount || 0;

    const deptNames = {};

    attendance.forEach(r => {
      const dept = r.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      const name = r.name || "";

      if (!deptNames[dept]) deptNames[dept] = [];
      if (name) deptNames[dept].push(name);
    });

    const box = document.getElementById("departmentsBox");
    box.innerHTML = "";

    Object.entries(summary.byDepartment || {}).forEach(([dept, count]) => {
      box.innerHTML += `
        <div class="dept-card">
          <h4>${dept}</h4>
          <div class="present">âœ” Ø­Ø¶Ø±: ${count}</div>
          <div class="names">
            ${(deptNames[dept] || []).join("ØŒ ") || "-"}
          </div>
        </div>
      `;
    });

    if (doughnutChart) doughnutChart.destroy();
    doughnutChart = new Chart(attendanceDoughnut, {
      type: "doughnut",
      data: {
        labels: ["Ø­Ø¶Ø±", "ØºØ§Ø¨"],
        datasets: [{
          data: [summary.inCount, summary.outCount],
          backgroundColor: ["#22c55e", "#ef4444"]
        }]
      }
    });

    if (barChart) barChart.destroy();
    barChart = new Chart(attendanceBar, {
      type: "bar",
      data: {
        labels: Object.keys(summary.byDepartment || {}),
        datasets: [{
          label: "Ø§Ù„Ø­Ø¶ÙˆØ±",
          data: Object.values(summary.byDepartment || {}),
          backgroundColor: "#22c55e"
        }]
      }
    });

  });
}

loadDashboard();
</script>

</body>
</html>
