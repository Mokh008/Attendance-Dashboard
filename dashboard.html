<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: #020617;
  color: #e5e7eb;
}

header {
  background: #0f172a;
  padding: 15px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

.container { padding: 20px; }

/* Loader */
#loader {
  position: fixed;
  inset: 0;
  background: rgba(2,6,23,.85);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  z-index: 999;
  display: none;
}

.date-box {
  text-align: center;
  margin-bottom: 20px;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.card {
  background: #0f172a;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.card h3 { margin: 0; font-size: 14px; color: #94a3b8; }
.card p { margin-top: 10px; font-size: 26px; font-weight: bold; color: #6366f1; }

.departments {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 15px;
}

.dept-card {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
}

.dept-card h4 {
  text-align: center;
  color: #c7d2fe;
}

.present { color: #22c55e; }
.absent  { color: #ef4444; }

.names {
  font-size: 12px;
  margin-top: 8px;
  line-height: 1.6;
  border-top: 1px solid #1e293b;
  padding-top: 6px;
  max-height: 120px;
  overflow-y: auto;
}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div id="loader">⏳ جاري تحميل البيانات…</div>

<div class="container">

  <div class="date-box">
    <input id="datePicker">
  </div>

  <div class="cards">
    <div class="card"><h3>إجمالي المهندسين</h3><p id="total">-</p></div>
    <div class="card"><h3>حضر</h3><p id="inCount">-</p></div>
    <div class="card"><h3>غاب</h3><p id="outCount">-</p></div>
  </div>

  <div class="departments" id="departmentsBox"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";
const TOTAL_EMPLOYEES = 32;

const user = JSON.parse(sessionStorage.getItem("user"));
if (!user) location.href = "index.html";

const loader = document.getElementById("loader");

flatpickr("#datePicker", {
  defaultDate: "today",
  dateFormat: "Y-m-d",
  onChange: loadDashboard
});

function loadDashboard(selectedDates, dateStr) {
  const date = dateStr || new Date().toISOString().slice(0,10);
  loader.style.display = "flex";

  fetch(`${API_URL}?action=attendance&role=${user.role}&region=${user.region}&date=${date}`)
    .then(r => r.json())
    .then(rows => {

      const seen = new Set();
      const presentSet = new Set();
      const employees = {};

      rows.forEach(r => {
        if (!r.empId) return;

        if (!employees[r.empId]) {
          employees[r.empId] = {
            name: r.name,          // ✅ من Sheet1 عمود H
            dept: r.department || "غير محدد"
          };
        }

        if (r.status === "IN") {
          presentSet.add(r.empId);
        }
      });

      const departments = {};
      Object.values(employees).forEach(emp => {
        if (!departments[emp.dept]) {
          departments[emp.dept] = { present: [], absent: [] };
        }
      });

      Object.entries(employees).forEach(([id, emp]) => {
        if (presentSet.has(id)) {
          departments[emp.dept].present.push(emp.name);
        } else {
          departments[emp.dept].absent.push(emp.name);
        }
      });

      document.getElementById("total").textContent = TOTAL_EMPLOYEES;
      document.getElementById("inCount").textContent = presentSet.size;
      document.getElementById("outCount").textContent = TOTAL_EMPLOYEES - presentSet.size;

      const box = document.getElementById("departmentsBox");
      box.innerHTML = "";

      Object.entries(departments).forEach(([dept, d]) => {
        box.innerHTML += `
          <div class="dept-card">
            <h4>${dept}</h4>
            <div class="names">
              <strong class="present">✔ حضر (${d.present.length})</strong><br>
              ${d.present.join("، ") || "-"}
              <hr>
              <strong class="absent">✖ غاب (${d.absent.length})</strong><br>
              ${d.absent.join("، ") || "-"}
            </div>
          </div>
        `;
      });

      loader.style.display = "none";
    });
}

loadDashboard();
</script>

</body>
</html>
