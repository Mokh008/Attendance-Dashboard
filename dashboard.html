<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: #020617;
  color: #e5e7eb;
}
header {
  background: #0f172a;
  padding: 15px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}
.container { padding: 20px; }
.date-box { text-align: center; margin-bottom: 20px; }
.date-box input {
  background: #020617; color: #fff;
  border: 1px solid #334155;
  padding: 8px 12px; border-radius: 8px;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}
.card {
  background: #0f172a;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.departments {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
}
.dept-card {
  background: #0f172a;
  padding: 15px;
  border-radius: 12px;
}
.dept-card h4 {
  text-align: center;
  color: #c7d2fe;
}

.notice {
  text-align: center;
  color: #94a3b8;
  padding: 30px;
  font-size: 14px;
}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div class="container">

  <div class="date-box">
    <input type="date" id="datePicker">
  </div>

  <div class="cards">
    <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3><p>32</p></div>
    <div class="card"><h3>Ø­Ø¶Ø±</h3><p id="inCount">0</p></div>
    <div class="card"><h3>ØºØ§Ø¨</h3><p id="outCount">32</p></div>
  </div>

  <div class="departments" id="departmentsBox"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";
const TOTAL_EMPLOYEES = 32;

const user = JSON.parse(sessionStorage.getItem("user"));
if (!user) location.href = "index.html";

const dateInput = document.getElementById("datePicker");
dateInput.value = new Date().toLocaleDateString("en-CA");
dateInput.addEventListener("change", loadDashboard);

function loadDashboard() {
  const date = dateInput.value;

  fetch(`${API_URL}?action=attendance&role=${user.role}&region=${user.region}&date=${date}`)
    .then(r => r.json())
    .then(rows => {

      const box = document.getElementById("departmentsBox");
      box.innerHTML = "";

      // ğŸ”´ Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ Ø¨ØµÙ…Ø§Øª
      if (!rows || rows.length === 0) {
        box.innerHTML = `
          <div class="dept-card">
            <h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <div class="notice">
              Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø­Ø¶ÙˆØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
            </div>
          </div>
        `;
        document.getElementById("inCount").textContent = 0;
        document.getElementById("outCount").textContent = TOTAL_EMPLOYEES;
        return;
      }

      // Ù„Ùˆ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
      const departments = {};
      const presentSet = new Set();

      rows.forEach(r => {
        if (!r.empId) return;

        if (!departments[r.department]) {
          departments[r.department] = [];
        }

        if (r.status === "IN") {
          presentSet.add(r.empId);
          departments[r.department].push(r.name);
        }
      });

      document.getElementById("inCount").textContent = presentSet.size;
      document.getElementById("outCount").textContent = TOTAL_EMPLOYEES - presentSet.size;

      Object.entries(departments).forEach(([dept, names]) => {
        box.innerHTML += `
          <div class="dept-card">
            <h4>${dept}</h4>
            <div class="notice">
              Ø­Ø¶Ø±: ${names.length}<br>
              ${names.join("ØŒ ") || "-"}
            </div>
          </div>
        `;
      });

    });
}

loadDashboard();
</script>

</body>
</html>
