<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,sans-serif;
  background:#020617;
  color:#e5e7eb;
}
header{
  background:#0f172a;
  padding:12px;
  text-align:center;
  font-size:18px;
  font-weight:bold;
}
.container{padding:16px}

/* Date */
.date-box{text-align:center;margin-bottom:12px}
.date-box input{
  background:#020617;
  color:#fff;
  border:1px solid #334155;
  padding:6px 10px;
  border-radius:6px;
  font-size:13px;
}

/* Cards */
.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:15px;
}
.card{
  background:#0f172a;
  padding:12px;
  border-radius:10px;
  text-align:center;
}
.card h3{
  margin:0;
  font-size:14px;
  color:#c7d2fe;
}
.card p{
  margin:6px 0 0;
  font-size:20px;
  font-weight:bold;
}

/* Charts Layout */
.charts{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:15px;
  margin-bottom:20px;
}
.chart-box{
  background:#0f172a;
  padding:12px;
  border-radius:12px;
}
.chart-box h4{
  margin:0 0 10px;
  font-size:14px;
  text-align:center;
  color:#93c5fd;
}

/* Departments */
.departments{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:12px;
}
.dept-card{
  background:#0f172a;
  padding:12px;
  border-radius:12px;
}
.dept-card h4{
  text-align:center;
  font-size:14px;
  margin:0 0 8px;
  color:#c7d2fe;
}
.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.box{
  background:#020617;
  border-radius:8px;
  padding:8px;
  font-size:12px;
}
.att-row{
  display:flex;
  gap:6px;
  padding:4px 0;
  border-bottom:1px dashed #1e293b;
}
.att-name{flex:2}
.att-loc{flex:1;color:#93c5fd}
.att-time{color:#c7d2fe}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div class="container">

<div class="date-box">
  <input type="date" id="datePicker">
</div>

<!-- Cards -->
<div class="cards">
  <div class="card">
    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3>
    <p id="totalCount">0</p>
  </div>
  <div class="card">
    <h3>Ø­Ø¶Ø±</h3>
    <p id="inCount">0</p>
  </div>
  <div class="card">
    <h3>ØºØ§Ø¨</h3>
    <p id="outCount">0</p>
  </div>
</div>

<!-- Charts -->
<div class="charts">
  <div class="chart-box">
    <h4>Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª</h4>
    <canvas id="deptChart" height="160"></canvas>
  </div>
  <div class="chart-box">
    <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</h4>
    <canvas id="pieChartCanvas" height="160"></canvas>
  </div>
</div>

<!-- Departments -->
<div class="departments" id="departmentsBox"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycby9We83tXmtxG_1ykdriEXyASO_685z1ieBrMb9HJpRdEYs8KXhzAkjFyaCchjgwoQAzg/exec";

const ENGINEER_DEPT = {
  "Mohamed Abdellatif Abdelhamid Aly":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Efat Youssef Assad Hanna":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Waleed Mahmoud Ismaiel Abdelrahim":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Ahmed Abdelnasser Mohamed Aly":"ØªÙˆØ±ÙŠØ¯Ø§Øª",
  "Amr Abdullah Abdrabbo Hlhil":"Ø¢Ù„Ù‰",
  "Wael Ibrahim Eid Mohamed":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Aly Aboseif Abdelbadea Aly Abosaif":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mahmoud Fathy Youssef Ismail":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Hussien Kamel Abdelkarem Abdelelamam":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Reda Mekhemar Abdelhamid Abdelhakim":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Khaled Mohamed Khaled":"ØªÙˆØ±ÙŠØ¯Ø§Øª",
  "Alaaeldien Mohamed Soliman AbdelhAlym":"Ø¢Ù„Ù‰",
  "Afraim Shawky Mikhail Habashy":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Hussien Mohamed Ahmed":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Ahmed Abdelfattah Aly Aly":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Mohamed Moustafa Abdelrahman Reyad":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Abdullah Shaaban Saad Mourad":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Elfarouk Mohamed Ahmed Mohamed":"Ù…ØªØ§Ø¨Ø¹Ù‡",
  "Essam Sayed Mohamed Seddik":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Eltawab Mahmoud Aly Aboelhassan":"Ø¢Ù„Ù‰",
  "Ibrahim Abdelnaser Abdelshafy Abdellatif":"Ø¢Ù„Ù‰",
  "Mohamed Saeed Aboelhagag Hassan":"Ø¢Ù„Ù‰",
  "Ahmed Mohamed Farouk Abdelrheam":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Ahmed Rabie Abdelrazik Hussien":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Atef Mahmoud Elgeneidy":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Ali Ahmed Hassan Hamed":"Ø¢Ù„Ù‰",
  "Assem Hassan Abdelshafy Hassan":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Omar Metwally Ahmed Mohamed Salem":"Ø¢Ù„Ù‰",
  "Abdelmoneam Hassan Hafez Karrat":"Ø¢Ù„Ù‰",
  "Mahmoud Ramadan Mahmoud Abdelaziz":"Ø¢Ù„Ù‰",
  "Mahmoud Khaled":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Youssef":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§"
};

const DEPARTMENTS = ["Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ","Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§","ØªÙˆØ±ÙŠØ¯Ø§Øª","Ø¢Ù„Ù‰","Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§","Ù…ØªØ§Ø¨Ø¹Ù‡"];
const ENGINEERS = Object.keys(ENGINEER_DEPT);
const TOTAL = ENGINEERS.length;

document.getElementById("totalCount").textContent = TOTAL;

let barChart = null;
let pieChart = null;

/* ================= DATE ================= */
const dateInput = document.getElementById("datePicker");
const today = new Date().toLocaleDateString("en-CA");
dateInput.value = today;
dateInput.addEventListener("change", loadDashboard);

/* ================= MAIN ================= */
function loadDashboard(){
  const selectedDate = dateInput.value;

  fetch(`${API_URL}?action=attendance&date=${selectedDate}`)
    .then(r => r.json())
    .then(rows => {
      if (!Array.isArray(rows)) return;

      rows = rows.filter(r => r.date === selectedDate);

      const presentSet = new Set();
      const deptData = {};
      DEPARTMENTS.forEach(d => deptData[d] = []);

      rows.forEach(r => {
        if (r.status === "IN" && ENGINEER_DEPT[r.name]) {
          presentSet.add(r.name);
          deptData[ENGINEER_DEPT[r.name]].push({
            name: r.name,
            location: r.location || "-",
            time: r.time || "-"
          });
        }
      });

      document.getElementById("inCount").textContent = presentSet.size;
      document.getElementById("outCount").textContent = TOTAL - presentSet.size;

      renderDepartments(deptData, presentSet);
      drawCharts(deptData, presentSet.size);
    });
}

/* ================= UI ================= */
function renderDepartments(deptData, presentSet){
  const box = document.getElementById("departmentsBox");
  box.innerHTML = "";

  DEPARTMENTS.forEach(dept => {
    const allDeptEngineers = ENGINEERS.filter(e => ENGINEER_DEPT[e] === dept);
    const presentNames = deptData[dept].map(x => x.name);
    const absent = allDeptEngineers.filter(e => !presentSet.has(e));

    box.innerHTML += `
      <div class="dept-card">
        <h4>${dept}</h4>
        <div class="split">
          <div class="box">
            <b>Ø­Ø¶Ø± (${presentNames.length})</b>
            ${deptData[dept].map(p => `
              <div class="att-row">
                <span class="att-name">${p.name}</span>
                <span class="att-loc">ğŸ“ ${p.location}</span>
                <span class="att-time">â° ${p.time}</span>
              </div>
            `).join("") || "-"}
          </div>
          <div class="box">
            <b>ØºØ§Ø¨ (${absent.length})</b><br>
            ${absent.join("<br>") || "-"}
          </div>
        </div>
      </div>
    `;
  });
}

/* ================= Charts ================= */
function drawCharts(deptData, inCount){
  if (barChart) barChart.destroy();
  if (pieChart) pieChart.destroy();

  barChart = new Chart(document.getElementById("deptChart"),{
    type:"bar",
    data:{
      labels:DEPARTMENTS,
      datasets:[{
        label:"Ø­Ø¶Ø±",
        data:DEPARTMENTS.map(d => deptData[d].length),
        backgroundColor:"#60a5fa"
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"#e5e7eb"}},
        y:{ticks:{color:"#e5e7eb"}}
      }
    }
  });

  pieChart = new Chart(document.getElementById("pieChartCanvas"),{
    type:"pie",
    data:{
      labels:["Ø­Ø¶Ø±","ØºØ§Ø¨"],
      datasets:[{
        data:[inCount, TOTAL - inCount],
        backgroundColor:["#60a5fa","#a5b4fc"]
      }]
    },
    options:{
      plugins:{legend:{position:"bottom",labels:{color:"#e5e7eb"}}}
    }
  });
}

/* ================= AUTO REFRESH ================= */
setInterval(() => {
  if (dateInput.value === today) loadDashboard();
}, 30000);

loadDashboard();
</script>

</body>
</html>
