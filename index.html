<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ================= AUTH GUARD ================= -->
<script>
/*
  Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†ÙŠ Ù„Ù„Ù€ Dashboard
  - Ù„Ùˆ Ù…ÙÙŠØ´ Session â†’ ÙŠØ±Ø¬Ø¹ Login
  - Ù„Ùˆ ÙÙŠÙ‡ â†’ ÙŠÙƒÙ…Ù‘Ù„ Ø·Ø¨ÙŠØ¹ÙŠ
*/
const AUTH_RAW = sessionStorage.getItem("authUser");

if(!AUTH_RAW){
  alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
  location.href = "https://mokh008.github.io/Attendance-Login/";
}

const AUTH_USER = JSON.parse(AUTH_RAW);
const USER_ROLE   = AUTH_USER.role;
const USER_REGION = AUTH_USER.region;
</script>
<!-- ============================================== -->

<style>
/* ================= THEME ================= */
:root{
  --bg-main:#020617;
  --bg-soft:#0b1224;
  --card:#0f172a;
  --border:#1e293b;

  --text:#e5e7eb;
  --text-soft:#94a3b8;

  --accent:#38bdf8;
  --accent-2:#818cf8;
}

/* ================= BASE ================= */
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,sans-serif;
  background:radial-gradient(circle at top,var(--bg-soft),var(--bg-main) 60%);
  color:var(--text);
}
header{
  background:linear-gradient(90deg,#020617,#0f172a,#020617);
  padding:14px;
  text-align:center;
  font-size:18px;
  font-weight:700;
  border-bottom:1px solid var(--border);
}
.container{padding:18px}

/* ================= DATE ================= */
.date-box{text-align:center;margin-bottom:18px}
.date-box input{
  background:var(--card);
  color:#fff;
  border:1px solid var(--border);
  padding:9px 16px;
  border-radius:12px;
  font-size:14px;
  font-weight:600;
  outline:none;
}
.date-box input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(56,189,248,.18);
}

/* ================= KPI ================= */
.cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-bottom:22px;
}
.card{
  background:linear-gradient(160deg,var(--card),var(--bg-main));
  padding:16px;
  border-radius:18px;
  text-align:center;
  border:1px solid var(--border);
  box-shadow:0 10px 28px rgba(0,0,0,.25);
}
.card h3{
  margin:0;
  font-size:13px;
  font-weight:600;
  color:var(--text-soft);
}
.card p{
  margin-top:8px;
  font-size:28px;
  font-weight:800;
  color:var(--accent);
}

/* ================= CHARTS ================= */
.charts{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:18px;
  margin-bottom:26px;
}
.chart-box{
  background:linear-gradient(160deg,var(--card),var(--bg-main));
  padding:16px;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:0 10px 28px rgba(0,0,0,.25);
}

/* ================= DEPARTMENTS ================= */
.departments{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(540px,1fr));
  gap:20px;
}
.dept-card{
  background:linear-gradient(160deg,var(--card),var(--bg-main));
  padding:18px;
  border-radius:20px;
  border:1px solid var(--border);
  box-shadow:0 10px 28px rgba(0,0,0,.25);
}
.dept-card h4{
  margin:0 0 14px;
  font-size:16px;
  font-weight:700;
  color:#e0e7ff;
}

/* ================= SPLIT ================= */
.split{
  display:grid;
  grid-template-columns:2fr .9fr;
  gap:14px;
}

/* ================= BOX ================= */
.box{
  background:var(--bg-main);
  border-radius:14px;
  padding:12px;
  font-size:13px;
  max-height:300px;
  overflow:auto;
  border:1px solid var(--border);
}
.box b{
  display:block;
  margin-bottom:8px;
  color:var(--accent);
  font-weight:700;
}

/* ================= ATT ROW ================= */
.att-row{
  display:grid;
  grid-template-columns:180px 1fr auto;
  align-items:center;
  gap:12px;
  padding:8px 0;
  border-bottom:1px dashed var(--border);
}
.att-row:last-child{border-bottom:none}

.att-name{
  font-weight:700;
  white-space:nowrap;
}
.att-loc{
  color:#7dd3fc;
  font-size:13px;
  white-space:nowrap;
}
.att-time{
  font-size:12px;
  font-weight:700;
  color:#fff;
  background:linear-gradient(135deg,#2563eb,#38bdf8);
  padding:4px 10px;
  border-radius:8px;
  white-space:nowrap;
}

/* ================= ABSENT ================= */
.absent-name{
  display:block;
  padding:3px 0;
  color:#cbd5f5;
  font-weight:500;
}
</style>
</head>

<body>

<header>Attendance Dashboard</header>

<div class="container">

<div class="date-box">
  <input type="date" id="datePicker">
</div>

<div class="cards">
  <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3><p id="totalCount">0</p></div>
  <div class="card"><h3>Ø­Ø¶Ø±</h3><p id="inCount">0</p></div>
  <div class="card"><h3>ØºØ§Ø¨</h3><p id="outCount">0</p></div>
</div>

<div class="charts">
  <div class="chart-box"><canvas id="deptChart"></canvas></div>
  <div class="chart-box"><canvas id="pieChartCanvas"></canvas></div>
</div>

<div class="departments" id="departmentsBox"></div>

</div>

<script>
/* ================= HELPERS ================= */
function shortName(fullName){
  if(!fullName) return "";
  const p = fullName.trim().split(" ");
  return p.length >= 2 ? p[0] + " " + p[1] : fullName;
}
function formatSheetTime(t){
  if(!t) return "";
  const d = new Date(t);
  return d.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true});
}

/* ================= CONFIG ================= */
const API_URL ="https://script.google.com/macros/s/AKfycbwLFKF--C1HL_3JnAQAsZZir0Cd2s6lSJAAu4R7zIA_D_KRM6d8QsVpK_h49qiM8PMBaQ/exec";

const ENGINEER_DEPT = { /* Ù†ÙØ³ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ØªØ§Ø¹ØªÙƒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ */ 
  "Mohamed Abdellatif Abdelhamid Aly":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Efat Youssef Assad Hanna":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Waleed Mahmoud Ismaiel Abdelrahim":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Ahmed Abdelnasser Mohamed Aly":"ØªÙˆØ±ÙŠØ¯Ø§Øª",
  "Amr Abdullah Abdrabbo Hlhil":"Ø¢Ù„Ù‰",
  "Wael Ibrahim Eid Mohamed":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Aly Aboseif Abdelbadea Aly Abosaif":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mahmoud Fathy Youssef Ismail":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Hussien Kamel Abdelkarem Abdelelamam":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Reda Mekhemar Abdelhamid Abdelhakim":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Khaled Mohamed Khaled":"ØªÙˆØ±ÙŠØ¯Ø§Øª",
  "Alaaeldien Mohamed Soliman AbdelhAlym":"Ø¢Ù„Ù‰",
  "Afraim Shawky Mikhail Habashy":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Hussien Mohamed Ahmed":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Ahmed Abdelfattah Aly Aly":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Mohamed Moustafa Abdelrahman Reyad":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Abdullah Shaaban Saad Mourad":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Elfarouk Mohamed Ahmed Mohamed":"Ù…ØªØ§Ø¨Ø¹Ù‡",
  "Essam Sayed Mohamed Seddik":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Eltawab Mahmoud Aly Aboelhassan":"Ø¢Ù„Ù‰",
  "Ibrahim Abdelnaser Abdelshafy Abdellatif":"Ø¢Ù„Ù‰",
  "Mohamed Saeed Aboelhagag Hassan":"Ø¢Ù„Ù‰",
  "Ahmed Mohamed Farouk Abdelrheam":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Ahmed Rabie Abdelrazik Hussien":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Atef Mahmoud Elgeneidy":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Ali Ahmed Hassan Hamed":"Ø¢Ù„Ù‰",
  "Assem Hassan Abdelshafy Hassan":"Ø¨Ù†Ù‰ Ø³ÙˆÙŠÙ",
  "Omar Metwally Ahmed Mohamed Salem":"Ø¢Ù„Ù‰",
  "Abdelmoneam Hassan Hafez Karrat":"Ø¢Ù„Ù‰",
  "Mahmoud Ramadan Mahmoud Abdelaziz":"Ø¢Ù„Ù‰",
  "Mahmoud Khaled":"Ø¬Ù†ÙˆØ¨ Ø§Ù„Ù…Ù†ÙŠØ§",
  "Mohamed Youssef":"Ø´Ù…Ø§Ù„ Ø§Ù„Ù…Ù†ÙŠØ§"
};

const ENGINEERS = Object.keys(ENGINEER_DEPT);

/* ===== ADD ONLY (ROLE FILTER) ===== */
const VISIBLE_ENGINEERS =
  USER_ROLE === "sector_manager"
    ? ENGINEERS
    : ENGINEERS.filter(e => ENGINEER_DEPT[e] === USER_REGION);
/* ================================ */

const TOTAL = VISIBLE_ENGINEERS.length;
totalCount.textContent = TOTAL;

const DEPARTMENTS = [...new Set(Object.values(ENGINEER_DEPT))];

let barChart=null, pieChart=null, lastSignature="";

/* ================= DATE ================= */
const dateInput=document.getElementById("datePicker");
const today=new Date().toLocaleDateString("en-CA");
dateInput.value=today;
dateInput.addEventListener("change",loadDashboard);

/* ================= LOAD ================= */
function loadDashboard(){
  const d=dateInput.value;
  fetch(`${API_URL}?action=attendance&role=${USER_ROLE}&region=${USER_REGION}&date=${d}`)
  .then(r=>r.json()).then(rows=>{
    if(!Array.isArray(rows))return;

    const presentSet=new Set();
    const deptData={};
    DEPARTMENTS.forEach(x=>deptData[x]=[]);

    rows.filter(r=>r.date===d && r.status==="IN").forEach(r=>{
      if(!ENGINEER_DEPT[r.name]) return;
      if(USER_ROLE!=="sector_manager" && ENGINEER_DEPT[r.name]!==USER_REGION) return;

      presentSet.add(r.name);
      deptData[ENGINEER_DEPT[r.name]].push(r);
    });

    inCount.textContent=presentSet.size;
    outCount.textContent=TOTAL-presentSet.size;

    renderDepartments(deptData,presentSet);
    drawCharts(deptData,presentSet.size);
  });
}

/* ================= UI ================= */
function renderDepartments(deptData,presentSet){
  const box=document.getElementById("departmentsBox");
  box.innerHTML="";

  DEPARTMENTS.forEach(dept=>{
    if(USER_ROLE!=="sector_manager" && USER_REGION!==dept) return;

    const all=VISIBLE_ENGINEERS.filter(e=>ENGINEER_DEPT[e]===dept);
    const present=deptData[dept].map(x=>x.name);
    const absent=all.filter(e=>!presentSet.has(e));

    box.innerHTML+=`
    <div class="dept-card">
      <h4>${dept}</h4>
      <div class="split">
        <div class="box">
          <b>Ø­Ø¶Ø± (${present.length})</b>
          ${deptData[dept].map(p=>`
            <div class="att-row">
              <span class="att-name">${shortName(p.name)}</span>
              <span class="att-loc">ğŸ“ ${p.location}</span>
              <span class="att-time">â° ${formatSheetTime(p.time)}</span>
            </div>
          `).join("") || "-"}
        </div>
        <div class="box">
          <b>ØºØ§Ø¨ (${absent.length})</b>
          ${absent.map(a=>`<span class="absent-name">${shortName(a)}</span>`).join("") || "-"}
        </div>
      </div>
    </div>`;
  });
}

/* ================= CHARTS ================= */
function drawCharts(deptData,inCount){
  if(barChart)barChart.destroy();
  if(pieChart)pieChart.destroy();

  const CHART_DEPTS =
    USER_ROLE === "sector_manager" ? DEPARTMENTS : [USER_REGION];

  barChart=new Chart(deptChart,{
    type:"bar",
    data:{
      labels:CHART_DEPTS,
      datasets:[{
        data:CHART_DEPTS.map(d=>deptData[d]?.length || 0),
        backgroundColor:"#38bdf8"
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });

  pieChart=new Chart(pieChartCanvas,{
    type:"pie",
    data:{
      labels:["Ø­Ø¶Ø±","ØºØ§Ø¨"],
      datasets:[{
        data:[inCount,TOTAL-inCount],
        backgroundColor:["#38bdf8","#818cf8"]
      }]
    }
  });
}

loadDashboard();
</script>

</body>
</html>
